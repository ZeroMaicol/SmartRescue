<!DOCTYPE html>
<html lang="it">
<head>
  <title>Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="static/css/reset.css">
  <link rel="stylesheet" href="static/css/map.css">
  <link rel="stylesheet" type="text/css" href="/static/css/custom-responsive-style.css">
  <link rel="stylesheet" href="https://api.mazemap.com/js/v2.0.41/mazemap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/vue"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://npmcdn.com/vue-router/dist/vue-router.js"></script>
  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="/static/css/index.css">
  <link rel="stylesheet" type="text/css" href="/static/css/custom-responsive-style.css">
  <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
  <script type="text/javascript" src="/static/js/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/static/js/all-plugins.js"></script>
  <script type="text/javascript" src="/static/js/plugin-active.js"></script>
  <script type='text/javascript' src='https://api.mazemap.com/js/v2.0.41/mazemap.min.js'></script>


</head>

<body>
<div id="app">
<div id="main" class="container">
  <div class='mazemap' id ='map'  tabindex="0" aria-label="Map"></div>
  <modal v-cloak v-if="modalVisible" @close="modalVisible = false">
    <img slot="image" v-show="false" alt="hidden">
    <h5 slot="header">
      <span class="congratz">Thing {{modalData.thingID}}</span>
      <span class="congratz">Shadow {{modalData.shadowName}} of type {{modalData.shadowType}}</span>
    </h5>
    <h6 v-cloak slot="body"><strong>Position</strong>: Lat({{modalData.shadowLat}}), Long({{modalData.shadowLong}}), Z-floor({{modalData.shadowZFloor}}) </h6>
    <h7 v-cloak slot="body"><strong>Reported</strong>
      <div style="height:100px;width:200px;border:1px solid #ccc;font:16px/26px Georgia, Garamond, Serif;overflow:auto;">
          {{modalData.reported}}
      </div>
    </h7>
  </modal>
</div>

</body>
<script src="https://cdn.jsdelivr.net/npm/vue"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://npmcdn.com/vue-router/dist/vue-router.js"></script>
<script>

Vue.component('modal', {
    template: `
    <transition name="modal">
    <div class="modal-mask">
    <div class="modal-wrapper">
      <div class="modal-container">

      <div class="modal-header">
        <slot name="header">
        default header
        </slot>
      </div>

      <div class="modal-body">
        <slot name="image">
          default image
        </slot>
        <slot name="body">
        default body
        </slot>
      </div>
      <div class="modal-footer">
        <slot name="footer">
        <div class="modal-default-links">
          <button class="btnModalDelete" @click="$emit('close')">
          OK
          </button>
        </div>
        </slot>
      </div>
      </div>
    </div>
    </div>
  </transition>
`,
});

var shadow = {
  thingID: '',
  shadowName: '',
  shadowImage: '',
  shadowDescription: '',
  shadowLat: '',
  shadowLong: '',
  shadowZFloor: '',
  shadowType: '',
  reported: ''
};

var app = new Vue({
	el:	"#app",
	data:	{
    dataReady: true,
    search: '',
    valueTest: 0,
    modalVisible: false,
    modalData: '',
    shadow: shadow,
    mazeMarkerList: []
	},
	methods: {
    showModal: function(value, message) {
      this.modalData.currentValue = value;
      this.modalData.message = message;
      this.modalVisible = true;
    },
    hideModal: function() {
      this.modalVisible = false;
      this.modalData.currentValue = "";
      this.modalData.messsage = "";
    },
    clearMarkers: function() {
      this.mazeMarkerList.forEach(marker => {
        marker.remove();
      })
      this.mazeMarkerList = [];
    },
    createRoute: function(myMap, start, dest) {
      var routeController = new Mazemap.RouteController(myMap);

      Mazemap.Data.getRouteJSON(start, dest)
        .then(function(geojson){
          routeController.setPath(geojson);

          // Fit the map bounds to the path bounding box
          var bounds = Mazemap.Util.Turf.bbox(geojson);
          myMap.fitBounds( bounds, {padding: 100} );
        });
    },
    makeMap: function() {
      var vm = this;

      var myMap = new Mazemap.Map({
          container: 'map',
          campuses: 50,
          center: {lng: -78.4985453236003, lat: 38.030998758211865},
          zoom: 19,
          scrollZoom: true,
          doubleClickZoom: false,
          touchZoomRotate: false,
          zLevelControl: true
      });

      myMap.on('load', function() {
        vm.loadData(myMap);
      //  vm.createRoute(myMap, start, dest);
      });
	},
  loadData: async function (myMap) {
    try {
        const things = await axios.get("/api/things");
        this.parseThingsToListShadow(things.data, myMap);
    } catch (error) {
        console.log(error);
    }
  },
  parseThingsToListShadow: function(things, myMap) {
    this.devices = [];
    //For sui Thing
    for (var thing in things) {
      var shadowList = [];
      //For sui devices
      for (var device in things[thing]) {
        //For sulle shadow
        for (var shadow in things[thing][device]) {
          var value = things[thing][device][shadow];
          axios.post("/api/getshadow", {thingName: thing, shadowName: value.friendly_name})
          .then(response => {
            if (response.data.errors && response.data.errors.length > 0) {
              console.log(error);
            } else {
              const json = JSON.parse(response.data.body);
              console.log(json);
              if (!json.hasOwnProperty("message")){
                this.shadow = {
                  thingID: response.data.thingName,
                  shadowName: response.data.shadowName,
                  shadowType: things[response.data.thingName][device][response.data.shadowName].type,
                  shadowImage: things[response.data.thingName][device][response.data.shadowName].img_path,
                  shadowDescription: things[response.data.thingName][device][response.data.shadowName].description,
                  shadowLat: things[response.data.thingName][device][response.data.shadowName].lat,
                  shadowLong: things[response.data.thingName][device][response.data.shadowName].long,
                  shadowZFloor: things[response.data.thingName][device][response.data.shadowName].zFloor,
                  reported: json.state.reported
                };
                this.makeMarker(this.shadow, myMap);
              }
            }
          }).catch(err => console.log(err))
        }
      }
    }
  },
  makeMarker: function(shadow, myMap) {
    var mazeMarker;

      var lngLat = {lng: shadow.shadowLong, lat: shadow.shadowLat};
      mazeMarker = new Mazemap.MazeMarker( {
          color: "MazeBlue",
          size: 36,
          zLevel: shadow.shadowZFloor,
          zLevel: 1,
          innerCircle: true,
          imgUrl: shadow.shadowImage,
          imgScale: 1.1,
          preventClickBubble: false // Allow click to go through to global map layer
        } ).setLngLat( lngLat ).addTo(myMap);

        this.mazeMarkerList.push({marker: mazeMarker, shadow: shadow});

        mazeMarker.on('click', () => {
          // Can also do extra click handling here...
          this.modalVisible = true;
          this.modalData = shadow;
        });
  },
  init: function(){
    this.clearMarkers();
    this.makeMap();
  }
},
	mounted(){
    this.init();
	}
});
</script>

</html>
